---
// src/components/Utils/SearchModal.astro
import { searchGroups, defaultSearch } from '@/data/searchConfig';
import allSites from '@/data/sites/all.js';
import { Icon } from 'astro-icon/components'
---

<div class="modal fade search-modal" id="search-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <div id="search" class="s-search mx-auto my-4">
          <div id="search-list" class="hide-type-list">
            <!-- 分类标签 -->
            <div class="s-type">
              <span id="group-current"></span>
              <div class="s-type-list">
                {searchGroups.map((group, index) => (
                  <label 
                    for={`m_${group.engines[0].id}`}
                    data-id={group.id}
                    class={index === 0 ? 'active' : ''}
                  >
                    {group.label}
                  </label>
                ))}
              </div>
            </div>

            <!-- 搜索引擎组 -->
            <div class="search-groups-container">
              {searchGroups.map((group, index) => (
                <div 
                  class={`search-group ${group.id}`}
                  style={`display: ${index === 0 ? 'block' : 'none'};`}
                >
                  <ul class="search-type">
                    {group.engines.map(engine => (
                      <li>
                        <input
                          type="radio"
                          name="type2"
                          id={`m_${engine.id}`}
                          value={engine.url}
                          data-placeholder={engine.placeholder}
                          checked={engine.id === defaultSearch.id}
                          hidden
                        />
                        <label for={`m_${engine.id}`}>
                          <span class="text-muted">{engine.label}</span>
                        </label>
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
            </div>
          </div>

          <!-- 搜索表单 -->
          <form 
            action={defaultSearch.url} 
            method="get" 
            target="_blank" 
            class="super-search-fm"
          >
            <input
              type="text"
              id="m_search-text"
              class="form-control smart-tips search-key"
              autocomplete="off"
              placeholder={defaultSearch.placeholder}
              style="outline:0"
              required
            />
            <button type="submit">
              <Icon name="ri:search-line" />
            </button>
          </form>
          <div id="smart-card-modal" class="card search-smart-tips search-hot-text" style="display:none">
            <ul id="m_word" style="display:none"></ul>
            <ul id="m_local_word" style="display:none"></ul>
          </div>
        </div>
      </div>
      
      <div style="position: absolute;bottom: -40px;width: 100%;text-align: center;">
        <a href="javascript:" data-dismiss="modal">
          <Icon name="ri:close-circle-line" class="icon-2x" />
        </a>
      </div>
    </div>
  </div>
</div>

<!-- 分组切换与模态框控制脚本 -->
<script is:inline define:vars={{allSites}}>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('search-modal');
  const container = modal;
  if (!container) return;

  function switchGroup(groupId) {
    container.querySelectorAll('.s-type-list label').forEach(label => {
      (label).classList.toggle('active', (label).dataset.id === groupId);
    });

    container.querySelectorAll('.search-group').forEach(group => {
      (group).style.display = group.classList.contains(groupId) ? 'block' : 'none';
    });

    const firstEngine = container.querySelector(`.search-group.${groupId} input[name="type2"]`);
    if (firstEngine) {
      updateSearchForm(firstEngine.value, firstEngine.dataset.placeholder || '');
    }
    const labelEl = container.querySelector(`.s-type-list label[data-id="${groupId}"]`)
      || container.querySelector('.s-type-list label.active');
    const display = container.querySelector('#group-current');
    if (display && labelEl) display.textContent = (labelEl.textContent || '').trim();
  }


  function updateSearchForm(action, placeholder) {
    const form = container.querySelector('.super-search-fm');
    const input = container.querySelector('#m_search-text');
    if (form) form.action = action;
    if (input && placeholder) input.placeholder = placeholder;
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]||c;}); }
  function getLocalSites(){ try{ return Array.isArray(allSites) ? allSites.map(s=>({ title: s.title||'', url: s.url||'', description: s.description||'', subId: s.subId||'' })) : []; }catch(e){ return []; } }
  function localSearchModal(keyword){
    const list = getLocalSites();
    const tips = container.querySelector('#m_local_word');
    const smartCard = container.querySelector('#smart-card-modal');
    if (!tips) return;
    keyword = (keyword||'').trim().toLowerCase();
    if (!keyword){ (tips).innerHTML=''; (tips).style.display='none'; if(smartCard){ var mword = container.querySelector('#m_word'); var netLen = mword && mword.children ? mword.children.length : 0; (smartCard).style.display = netLen ? 'block' : 'none'; } return; }
    const results = [];
    for (let i=0;i<list.length;i++){
      const item = list[i];
      const t = (item.title||'').toLowerCase();
      const d = (item.description||'').toLowerCase();
      const u = (item.url||'').toLowerCase();
      if (t.indexOf(keyword)>=0 || d.indexOf(keyword)>=0 || u.indexOf(keyword)>=0) results.push(item);
      if (results.length>=10) break;
    }
    (tips).style.display = results.length ? 'block' : 'none';
    (tips).innerHTML = results.map(r=>{
      const title = escapeHtml(r.title||r.url);
      const desc = escapeHtml(r.description||'');
      const text = desc ? (title + ' - ' + desc) : title;
      return '<li data-url="'+r.url+'"><span class="local">本地</span>'+ text +'</li>';
    }).join('');
    Array.prototype.slice.call(tips.querySelectorAll('li')).forEach(function(li){ li.addEventListener('click', function(){ var u = (li).getAttribute('data-url')||''; if(u){ try{ window.open(u,'_blank'); }catch(e){} } }); });
    if(smartCard){ var mword2 = container.querySelector('#m_word'); var netLen2 = mword2 && mword2.children ? mword2.children.length : 0; (smartCard).style.display = (results.length || netLen2) ? 'block' : 'none'; }
  }

  container.querySelectorAll('.s-type-list label').forEach(label => {
    label.addEventListener('click', function() {
      const gid = (this).dataset.id || '';
      if (gid) switchGroup(gid);
    });
  });
  
  container.querySelectorAll('input[name="type2"]').forEach(radio => {
    radio.addEventListener('change', function() {
      if ((this).checked) {
        updateSearchForm((this).value, (this).dataset.placeholder || '');
        var inputEl2 = container.querySelector('#m_search-text');
        var val = ((inputEl2 && inputEl2.value) ? inputEl2.value : '').trim();
        if ((this).id === 'm_type-local') {
          localSearchModal(val);
        } else {
          const tips = container.querySelector('#m_local_word');
          const smartCard = container.querySelector('#smart-card-modal');
          if (tips){ (tips).innerHTML=''; (tips).style.display='none'; }
          var mword3 = container.querySelector('#m_word');
          var netLen3 = mword3 && mword3.children ? mword3.children.length : 0;
          if (smartCard) (smartCard).style.display = netLen3 ? 'block' : 'none';
        }
      }
    });
  });
  
  const init = () => {
    const active = container.querySelector('.s-type-list label.active');
    const first = container.querySelector('.s-type-list label');  
    const gid = (active && active.dataset.id) || (first && first.dataset.id) || 'group-a';
    switchGroup(gid);
    const display = container.querySelector('#group-current');
    const labelEl = container.querySelector(`.s-type-list label[data-id="${gid}"]`) || active || first;
    if (display && labelEl) display.textContent = (labelEl.textContent || '').trim();
  };
  modal.addEventListener('shown.bs.modal', init);
  init();

  const mInputEl = container.querySelector('#m_search-text');
  if (mInputEl) mInputEl.addEventListener('keyup', function(){
    const val = (mInputEl.value || '').trim();
    const checked = container.querySelector('input[name="type2"]:checked');
    if (checked && checked.id === 'm_type-local') localSearchModal(val);
  });

  let backdrop = null;
  const body = document.body;
  function openModal() {
    modal.style.display = 'block';
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    body.appendChild(backdrop);
    body.style.overflow = 'hidden';
    body.classList.add('modal-open');
    try { modal.dispatchEvent(new Event('shown.bs.modal')); } catch(e) {}
  }
  function closeModal() {
    modal.classList.remove('show');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    if (backdrop) { backdrop.remove(); backdrop = null; }
    body.style.overflow = '';
    body.classList.remove('modal-open');
  }
  document.querySelectorAll('a[data-toggle="modal"][data-target="#search-modal"]').forEach(a => {
    a.addEventListener('click', function(e) { e.preventDefault(); openModal(); });
  });
  container.addEventListener('click', function(e) {
    if (e.target === container) closeModal();
  });
  document.addEventListener('click', function(e) {
    var t = e.target;
    if (!t || !(t).closest) return;
    if ((t).closest('[data-dismiss="modal"]')) { e.preventDefault(); closeModal(); }
  });
  window.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });
});
</script>
<style>
/* 模态框内使用左侧下拉+右侧子类布局 */
.search-modal #search{max-width:800px;position:relative}
.search-modal .s-type{position:absolute;top:0;left:0;z-index:23;width:75px}
.search-modal .s-type>span{display:block;height:31px;width:75px}
.search-modal .s-type>span{line-height:31px;text-align:center;color:#20272b;background:#f0f0f0;border-radius:5px}
.search-modal .s-type-list{display:none;position:absolute;top:45px;padding:2pt 0;width:70px;background:#fff;border-radius:5px;box-shadow:0 9px 20px rgba(0,0,0,.16)}
.search-modal .s-type:hover .s-type-list{display:block}
.search-modal .s-type-list label{display:block;font-size:14px;text-align:center;font-weight:normal;margin-bottom:0;padding:2px 0;cursor:pointer;transition:.3s;line-height:1.5}
.search-modal .s-type-list label span{display:block;padding:1px 7px !important;color:#20272b;background-color:#f0f0f0;border-radius:999px;text-shadow:none;font-size:12px;line-height:1.1}
.search-modal .search-group{padding-left:75px}
.search-modal #m_search-text{height:50px}
.search-modal #search form{position:relative}
.search-modal #search button{position:absolute;top:0;right:0;margin:0;height:50px;line-height:50px;background:#313437;border:0;color:#fff}
.io-grey-mode .search-modal #search button{color:#20272b;}
.io-black-mode .search-modal #search button{color:#fff;}
.search-modal #search button svg{color:#fff;width:18px;height:18px}
.io-grey-mode .search-modal #search button svg{color:#20272b;}
.io-black-mode .search-modal #search button svg{color:#fff;}
.search-type {display:flex;flex-wrap:wrap;gap:8px;padding:0;margin:0;list-style:none}
.search-type li {margin:0}
:global(.modal-open) #sidebar{filter:blur(6px);pointer-events:none;user-select:none;transition:filter .2s ease}
:global(.modal-open) .page-header{filter:blur(6px);pointer-events:none;user-select:none;transition:filter .2s ease}
:global(.modal-open) .main-content > :not(.search-modal){filter:blur(6px);pointer-events:none;user-select:none;transition:filter .2s ease}
.modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;z-index:1084}
:global(.modal-backdrop),
:global(.modal-backdrop.fade.show){
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.search-modal .modal-dialog{margin-top: 100px !important;}
.search-modal{z-index:1085}

/* 主题自适配 */
:global(.io-grey-mode) .search-modal .modal-content{background:#fff;color:#282a2d;border-color:#e5e7eb}
:global(.io-black-mode) .search-modal .modal-content{background:#2c2e2f;color:#c6c9cf;border-color:#404040}

:global(.io-grey-mode) .search-modal .s-type>span{background:#f0f0f0;color:#20272b;border:1px solid #e5e7eb}
:global(.io-black-mode) .search-modal .s-type>span{background:#2c2e2f;color:#c6c9cf;border:1px solid #404040}

:global(.io-grey-mode) .search-modal .s-type-list{background:#f0f0f0;box-shadow:0 9px 20px rgba(0,0,0,.16)}
:global(.io-black-mode) .search-modal .s-type-list{background:#363738;box-shadow:0 9px 20px rgba(0,0,.3)}

:global(.io-grey-mode) .search-modal .s-type-list label{color:#20272b; font-weight: 500;}
:global(.io-black-mode) .search-modal .s-type-list label{color:#c6c9cf}
:global(.io-grey-mode) .search-modal .s-type-list label.active{background:rgba(126,126,126,.05)}
:global(.io-black-mode) .search-modal .s-type-list label.active{background:rgba(255,255,255,.04)}

:global(.io-grey-mode) .search-modal #m_search-text{background:#fff;color:#2c2e2f;border:1px solid #e5e7eb}
:global(.io-black-mode) .search-modal #m_search-text{background:#2c2e2f;color:#fff;border:1px solid #2c2e2f}

:global(.io-grey-mode) .search-modal #search button{background:#313437}
:global(.io-black-mode) .search-modal #search button{background:#2c2e2f}
:global(.io-black-mode) .search-modal #search button:hover{background:#313437}

:global(.io-grey-mode) .search-modal .text-muted{color:#20272b!important; font-weight: 500;}
:global(.io-black-mode) .search-modal .text-muted{color:#bbb!important}
</style>
