---
// src/layouts/Layout.astro
import Sidebar from '../components/Sidebar.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_LABEL, KEYWORDs, SITE_DESCRIPTION, SITE_FAVICON, SITE_TITLE, SEARCH_BG, CONTENT_BG, SEARCH_BG_DARK, CONTENT_BG_DARK, SIDEBAR_BLUR, SIDEBAR_OPACITY, SIDEBAR_OPACITY_DARK, SIDEBAR_POPUP_OPACITY, SIDEBAR_POPUP_OPACITY_DARK, SIDEBAR_BORDER_COLOR_LIGHT, SIDEBAR_BORDER_COLOR_DARK } from '../settings';
import { LIGHT_MODE, DARK_MODE, AUTO_MODE, DEFAULT_THEME } from '../constants/constants';
import '../styles/global.css';
import '../styles/external.css';
import SearchModal from '@/components/Utils/SearchModal.astro';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
const isImageMeta = (v: unknown): v is ImageMetadata => !!v && typeof v === 'object' && 'src' in (v as any) && 'width' in (v as any) && 'height' in (v as any);
const darkSearchBg: ImageMetadata | null = (SEARCH_BG_DARK && isImageMeta(SEARCH_BG_DARK)) ? SEARCH_BG_DARK : (isImageMeta(SEARCH_BG) ? SEARCH_BG : null);
const contentDark: ImageMetadata | null = (CONTENT_BG_DARK && isImageMeta(CONTENT_BG_DARK)) ? CONTENT_BG_DARK : (isImageMeta(CONTENT_BG) ? CONTENT_BG : null);
const hasSearch = Astro.slots.has('searchbar');
const { hideFooter = false } = Astro.props;
---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f9f9f9" />
  <link rel="sitemap" href="/sitemap-index.xml" />
  <title>{SITE_TITLE}</title>
  <link rel="shortcut icon" href={SITE_FAVICON} />
  <meta name="keywords" content={KEYWORDs} />
  <meta name="description" content={SITE_DESCRIPTION} />

  <style>
    html, body{background-color:#f9f9f9}
    @media (prefers-color-scheme: dark){html, body{background-color:#1b1d1f}}
    body.io-black-mode{background-color:#1b1d1f!important;color:#c6c9cf!important}
    body.io-grey-mode{background-color:#f9f9f9!important;color:#282a2d!important}
    body{transition:background-color .3s ease,color .3s ease}
    body.theme-init{transition:none!important}
    :root{--sidebar-blur:12px;--sidebar-border-color:rgba(0,0,0,.06);--sidebar-bg-color:linear-gradient(to bottom, rgba(255,255,255,.65), rgba(255,255,255,.45));--sidebar-popup-bg-color:linear-gradient(to bottom, rgba(245,245,245,.75), rgba(245,245,245,.64));--sidebar-text-color:#20272b;--sidebar-title-color:#1b2226;--sidebar-hover-bg:rgba(0,0,0,.06);--sidebar-active-bg:rgba(0,0,0,.06);--sidebar-submenu-bg:rgba(0,0,0,.05)}
    /* 全局内容背景分层 */
    .global-bg-layer{position:fixed;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:0;pointer-events:none;opacity:0;transition:opacity .3s;filter:blur(var(--content-bg-blur,0px));width:100%;height:100%;object-fit:cover}
    body.io-grey-mode #global-bg-light{opacity:1}
    body.io-grey-mode #global-bg-dark{opacity:0}
    body.io-black-mode #global-bg-light{opacity:0}
    body.io-black-mode #global-bg-dark{opacity:1}
    /* 顶部搜索背景分层 */
    #search-bg{position:relative;overflow:visible}
    .search-bg-layer{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:0;pointer-events:none;opacity:0;transition:opacity .3s;filter:blur(var(--search-bg-blur,0px))}
    .page-container{position:relative;z-index:1;background:transparent !important}
    /* 移除顶部渐变遮罩，避免覆盖背景 */
    .header-big.bg-gradual:before{display:none}
    #search-bg > :not(.search-bg-layer){position:relative;z-index:1}
    body.io-grey-mode #search-bg-light{opacity:1}
    body.io-grey-mode #search-bg-dark{opacity:0}
    body.io-black-mode #search-bg-light{opacity:0}
    body.io-black-mode #search-bg-dark{opacity:1}
  </style>

  <script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE}}>
    (function() {
      // 使用与theme-utils.ts相同的逻辑
      function getStoredTheme() {
        const stored = localStorage.getItem('theme');
        return stored || DEFAULT_THEME;
      }
      
      function applyThemeToDocument(theme) {
        // 立即应用到body，不等待DOM加载
        const body = document.body || document.getElementsByTagName('body')[0];
        if (body) {
          // 移除现有的主题类
          body.classList.remove('io-grey-mode', 'io-black-mode');
          
          // 应用新的主题类
          switch (theme) {
            case LIGHT_MODE:
              body.classList.add('io-grey-mode');
              break;
            case DARK_MODE:
              body.classList.add('io-black-mode');
              break;
            case AUTO_MODE:
              if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                body.classList.add('io-black-mode');
              } else {
                body.classList.add('io-grey-mode');
              }
              break;
          }
        }
      }
      
      // 立即应用存储的主题
      const storedTheme = getStoredTheme();
      // 如果存储的是AUTO_MODE，LightDarkSwitch会默认设为LIGHT_MODE
      const theme = (storedTheme === LIGHT_MODE || storedTheme === DARK_MODE) ? storedTheme : LIGHT_MODE;
      
      try { (document.body || document.getElementsByTagName('body')[0]).classList.add('theme-init'); } catch(e) {}
      applyThemeToDocument(theme);
      requestAnimationFrame(function(){ try { (document.body || document.getElementsByTagName('body')[0]).classList.remove('theme-init'); } catch(e) {} });
      
      // 如果body还不存在，监听DOM变化
      if (!document.body) {
        const observer = new MutationObserver(function(mutations) {
          if (document.body) {
            observer.disconnect();
            applyThemeToDocument(theme);
          }
        });
        observer.observe(document.documentElement, { childList: true, subtree: true });
      }
    })();
  </script>
  <script is:inline define:vars={{SEARCH_BG, CONTENT_BG, SEARCH_BG_DARK, CONTENT_BG_DARK, DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE}}>
    (function(){
      try{
        var stored = localStorage.getItem('theme') || DEFAULT_THEME;
        var dark = stored === DARK_MODE ? true : (stored === LIGHT_MODE ? false : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches));
        function normalizeUrl(s){
          if(!s) return '';
          try{
            if (/^https?:\/\//i.test(s)) return s;
          }catch(e){}
          return s.startsWith('/') ? s : ('/' + s);
        }
        var searchImg = normalizeUrl(dark ? (SEARCH_BG_DARK || SEARCH_BG || '') : (SEARCH_BG || ''));
        var contentImg = normalizeUrl(dark ? (CONTENT_BG_DARK || CONTENT_BG || '') : (CONTENT_BG || ''));
        /* 由分层背景负责显示切换，不在此处写入 URL */
      }catch(e){}
    })();
  </script>
  <script is:inline>
    (function(){
      try{
        var stored = localStorage.getItem('miniSidebar') === '1';
        function apply(){
          var el = document.getElementById('sidebar');
          if(el){
            if(stored) el.classList.add('mini-sidebar');
            return true;
          }
          return false;
        }
        if(!apply()){
          var obs = new MutationObserver(function(){ if(apply()) obs.disconnect(); });
          obs.observe(document.documentElement,{childList:true,subtree:true});
        }
      }catch(e){}
    })();
  </script>
  
  <script src="../scripts/search-suggest.ts"></script>
  <script src="../scripts/sidebar-controller.ts"></script>
  <script src="../scripts/background-controller.ts"></script>
  <script src="../scripts/ui-controls.ts"></script>
</head>
<SearchModal />
<body class="page-loading io-grey-mode">
  {isImageMeta(CONTENT_BG) ? (
    <div id="global-bg-light" class="global-bg-layer">
      <Image 
        src={CONTENT_BG} 
        alt="" 
        format="webp"
        quality={80}
        width={1920}
        loading="eager"
        style={{ position: 'absolute', inset: 0, width: '100%', height: '100%', objectFit: 'cover' }}
      />
    </div>
  ) : (
    <div id="global-bg-light" class="global-bg-layer"></div>
  )}
  {contentDark ? (
    <div id="global-bg-dark" class="global-bg-layer">
      <Image 
        src={contentDark} 
        alt="" 
        format="webp"
        quality={80}
        width={1920}
        loading="eager"
        style={{ position: 'absolute', inset: 0, width: '100%', height: '100%', objectFit: 'cover' }}
      />
    </div>
  ) : (
    <div id="global-bg-dark" class="global-bg-layer"></div>
  )}
<div class="page-container">
  <Sidebar />
  <div class="main-content flex-fill"> 
    <Header />
    {hasSearch ? (
      <div class="header-big post-top css-color mb-4" id="search-bg">
        <div id="search-bg-light" class="search-bg-layer">
          {isImageMeta(SEARCH_BG) ? (
            <Image
              src={SEARCH_BG}
              alt="搜索背景（浅色模式)"
              format="webp"
              quality={100}
              width={1920}
              style={{ position: 'absolute', inset: 0, width: '100%', height: '100%', objectFit: 'cover', visibility: 'visible' }}
            />
          ) : null}
        </div>
        <div id="search-bg-dark" class="search-bg-layer">
          {darkSearchBg ? (
            <Image
              src={darkSearchBg}
              alt="搜索背景（深色模式)"
              format="webp"
              quality={100}
              width={1920}
              style={{ position: 'absolute', inset: 0, width: '100%', height: '100%', objectFit: 'cover', visibility: 'visible' }}
            />
          ) : null}
        </div>
        <div class="s-search">
          <slot name="searchbar" />
        </div>
      </div>
    ) : null}
    <div id="content" class="content-site customize-site">
      <slot />
    </div>
    {hideFooter ? null : <Footer />}
  </div>
</div>
</body>
</html>
